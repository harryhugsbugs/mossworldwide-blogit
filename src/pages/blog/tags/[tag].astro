---
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const posts = await getCollection("blog");
  const tagSet = new Set<string>();

  for (const p of posts) for (const t of (p.data.tags ?? [])) tagSet.add(String(t).trim());

  return [...tagSet].map((tag) => ({
    params: { tag: encodeURIComponent(tag) },
    props: { tag },
  }));
}

const { tag } = Astro.props as { tag: string };
const posts = (await getCollection("blog"))
  .filter((p) => (p.data.tags ?? []).map(String).includes(tag))
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
---

<h1>Tag: {tag}</h1>
<p><a href="/blog/tags/">All tags</a></p>

<ul>
  {posts.map((p) => (
    <li>
      <a href={`/blog/${p.slug}/`}>{p.data.title}</a>
      <small> â€” {p.data.pubDate.toLocaleDateString()}</small>
    </li>
  ))}
</ul>