---
import BaseHead from "../../../components/BaseHead.astro";
import Header from "../../../components/Header.astro";
import Footer from "../../../components/Footer.astro";
import FormattedDate from "../../../components/FormattedDate.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const posts = await getCollection("blog");
  const tagSet = new Set<string>();

  for (const p of posts) {
    for (const t of (p.data.tags ?? [])) tagSet.add(String(t).trim());
  }

  return [...tagSet].map((tag) => ({
    params: { tag: encodeURIComponent(tag) },
    props: { tag },
  }));
}

const { tag } = Astro.props as { tag: string };

const allPosts = await getCollection("blog");
const posts = allPosts
  .filter((p) => (p.data.tags ?? []).map(String).includes(tag))
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
---

<html lang="en">
  <head>
    <BaseHead title={`Tag: ${tag}`} description={`Posts tagged ${tag}`} />
    <style>
      main {
        width: calc(100% - 2em);
        max-width: 100%;
        margin: 0;
      }
      .prose {
        width: 720px;
        max-width: calc(100% - 2em);
        margin: auto;
        padding: 1em;
        color: rgb(var(--gray-dark));
      }
      .top {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 1rem;
        flex-wrap: wrap;
        margin: 1.5rem 0 1rem;
      }
      .top h1 {
        margin: 0;
      }
      .back {
        text-decoration: none;
        color: rgb(var(--gray));
      }
      .back:hover {
        color: rgb(var(--gray-dark));
      }
      ul {
        padding-left: 1.25rem;
      }
      .meta {
        color: rgb(var(--gray));
        font-size: 0.95rem;
      }
      .tagpill {
        display: inline-flex;
        padding: 0.35rem 0.7rem;
        border-radius: 999px;
        border: 1px solid rgba(0,0,0,0.12);
        background: rgba(255,255,255,0.6);
        font-size: 0.9rem;
        line-height: 1;
      }
    </style>
  </head>

  <body>
    <Header />
    <main>
      <div class="prose">
        <div class="top">
          <h1>
            Tag: <span class="tagpill">{tag}</span>
          </h1>
          <a class="back" href="/blog/">← Back to Blog</a>
        </div>

        {posts.length === 0 ? (
          <p class="meta">No posts found for this tag.</p>
        ) : (
          <ul>
            {posts.map((p) => (
              <li>
                <a href={`/blog/${p.slug}/`}>{p.data.title}</a>
                <span class="meta"> — <FormattedDate date={p.data.pubDate} /></span>
              </li>
            ))}
          </ul>
        )}
      </div>
    </main>
    <Footer />
  </body>
</html>